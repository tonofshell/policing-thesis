---
title: "Modeling"
author: "Adam Shelton"
date: "2/19/2020"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(glmnet)
library(knitr)
library(caret)
library(pROC)

knitr::opts_chunk$set(echo = TRUE, cache=TRUE, error=TRUE)

set.seed(60615)
merged_crime_data = readRDS(here("Data", "merged_crime_data_final.rds"))
```

## Data Preparation
```{r}
analysis_data = merged_crime_data %>% select(-c(id, case_number, description, block_id, location_description, reporting_dept)) %>% filter(in_ucpd_bound) %>% select(-in_ucpd_bound) %>% na.omit()

analysis_data %>% count(responding_dept) %>% kable()

partition_data = function(data_set, y, p = 0.75, ...) {
  train_indices = createDataPartition(unlist(data_set[y]), p = p, ...) %>% unlist()
  list("training" = data_set[train_indices, ], "testing" = data_set[-train_indices, ])
}

arrest_data = analysis_data %>% partition_data("arrest")
dept_data = analysis_data %>% partition_data("responding_dept")

```



## Lasso Regression

```{r lasso-prep}
glmnet_coefs_table = . %>% coef(s = .$lambda.1se) %>% as.matrix() %>% as_tibble(rownames = "var") %>% filter(`1` != 0) %>% mutate(`1` = round(`1`, 3))

mn_glmnet_coefs_table = function(obj) {
  coefs = coef(obj)
  out = coefs[[1]] %>% {tibble("Variable" = .@Dimnames[[1]], `1` = rep("", length(Variable)))}
  out$`1`[(coefs[[1]]@i)+1] = coefs[[1]]@x
  for (i in 2:length(coefs)) {
    out[as.character(i+1)] = rep("", nrow(out))
    out[as.character(i+1)][(coefs[[i]]@i+1),] = coefs[[i]]@x
  }
  names(out) = c("Variable", names(coefs))
  out
}
```

```{r lasso-arrests}
lasso_arrests_mod = arrest_data$training %>% {model.matrix(arrest ~ ., .)} %>% cv.glmnet(arrest_data$training$arrest, alpha = 1, type.measure = "auc", family = "binomial")
arrests_results = glmnet_coefs_table(lasso_arrests_mod)
arrests_results %>% write_csv(here("Modeling", "arrests_results.csv"))
plot(lasso_arrests_mod)
arrests_results %>% kable()

arrests_roc = roc(predict(lasso_arrests_mod, arrest_data$testing %>% {model.matrix(arrest ~ ., .)}, type = "response") %>% (function(x) x >0.5) %>% as.numeric(), arrest_data$testing$arrest %>% as.numeric())

plot(arrests_roc)
auc(arrests_roc)
```

```{r lasso-dept}
lasso_dept_mod = dept_data$training %>% {model.matrix(responding_dept ~ ., .)} %>% cv.glmnet(dept_data$training$responding_dept, alpha = 1, type.measure = "class", family = "multinomial")
plot(lasso_dept_mod)
dept_results = mn_glmnet_coefs_table(lasso_dept_mod) %>% filter(!((both == "") & (ucpd == "") & (cpd == "")))
dept_results %>% kable()
dept_results %>% write_csv(here("Modeling", "dept_results.csv"))

class_comp = tibble(actual = dept_data$testing$responding_dept, predict = predict(lasso_dept_mod, dept_data$testing %>% {model.matrix(responding_dept ~ ., .)}, type = "class")) %>% mutate(correct = predict == actual) %>% count(actual, correct) %>% kable()
accuracy = tibble(actual = dept_data$testing$responding_dept, predict = predict(lasso_dept_mod, dept_data$testing %>% {model.matrix(responding_dept ~ ., .)}, type = "class")) %>% mutate(correct = predict == actual) %>% select(correct) %>% unlist() %>% mean()
```

## RandomForest
```{r rf-arrests}

```


